package cmd

import (
	"fmt"
	"os"
	"path/filepath"

	"github.com/spf13/cobra"
)

var activateCmd = &cobra.Command{
	Use:   "activate",
	Short: "Generate shell activation script",
	Long: `Generate shell-specific activation script for convenient CCO usage.

Usage:
  bash/zsh:  eval "$(cco activate)"
  fish:      cco activate --fish | source

This will set up:
  - CCO environment variables
  - Convenient shell aliases
  - Shell completion (if available)`,
	RunE: runActivate,
}

var (
	fishShell bool
)

func init() {
	activateCmd.Flags().BoolVar(&fishShell, "fish", false, "Generate fish shell script")
}

func runActivate(cmd *cobra.Command, _ []string) error {
	// Detect shell if not explicitly specified
	shell := detectShell()

	if fishShell {
		shell = "fish"
	}

	// Get CCO binary path
	ccoBinary, err := os.Executable()
	if err != nil {
		ccoBinary = "cco" // Fallback to PATH lookup
	}

	switch shell {
	case "fish":
		fmt.Print(generateFishActivation(ccoBinary))
	default:
		// Default to bash/zsh compatible script
		fmt.Print(generateBashActivation(ccoBinary))
	}

	return nil
}

func detectShell() string {
	// Try to detect shell from SHELL environment variable
	shellPath := os.Getenv("SHELL")
	if shellPath == "" {
		return "bash" // Default to bash
	}

	shellName := filepath.Base(shellPath)
	switch shellName {
	case "fish":
		return "fish"
	case "zsh":
		return "zsh"
	default:
		return "bash"
	}
}

func generateBashActivation(ccoBinary string) string {
	return fmt.Sprintf(`# CCO Shell Activation (bash/zsh)
# Generated by: cco activate

# Set CCO home directory
export CCO_HOME="${HOME}/.claude-code-open"

# Convenient aliases
alias cco-start='%s start'
alias cco-stop='%s stop'
alias cco-status='%s status'
alias cco-models='%s models'
alias cco-config='%s config show'

# Quick model selection function
cco-model() {
  if [ -z "$1" ]; then
    echo "Usage: cco-model <provider>/<model>"
    echo "Example: cco-model openai/gpt-4o"
    echo ""
    echo "Available models:"
    %s models list
    return 1
  fi
  export CCO_MODEL="$1"
  echo "✓ CCO_MODEL set to: $1"
}

# Quick API key setup function
cco-key() {
  if [ -z "$1" ]; then
    echo "Usage: cco-key <api-key>"
    echo "Sets CCO_API_KEY for session"
    return 1
  fi
  export CCO_API_KEY="$1"
  echo "✓ CCO_API_KEY set (hidden for security)"
}

# Show current CCO environment
cco-env() {
  echo "CCO Environment:"
  echo "  CCO_HOME: ${CCO_HOME}"
  echo "  CCO_API_KEY: ${CCO_API_KEY:-(not set)}"
  echo "  CCO_MODEL: ${CCO_MODEL:-(not set)}"
  echo "  CCO Binary: %s"
}

# Completion (if available)
if command -v %s &> /dev/null; then
  if [ -n "$BASH_VERSION" ]; then
    source <(%s completion bash 2>/dev/null) || true
  elif [ -n "$ZSH_VERSION" ]; then
    source <(%s completion zsh 2>/dev/null) || true
  fi
fi

echo "✓ CCO shell environment activated"
echo "  Run 'cco-env' to see environment variables"
echo "  Run 'cco-model' to set the active model"
`, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary)
}

func generateFishActivation(ccoBinary string) string {
	return fmt.Sprintf(`# CCO Shell Activation (fish)
# Generated by: cco activate --fish

# Set CCO home directory
set -gx CCO_HOME "$HOME/.claude-code-open"

# Convenient aliases
alias cco-start='%s start'
alias cco-stop='%s stop'
alias cco-status='%s status'
alias cco-models='%s models'
alias cco-config='%s config show'

# Quick model selection function
function cco-model
  if test (count $argv) -eq 0
    echo "Usage: cco-model <provider>/<model>"
    echo "Example: cco-model openai/gpt-4o"
    echo ""
    echo "Available models:"
    %s models list
    return 1
  end
  set -gx CCO_MODEL $argv[1]
  echo "✓ CCO_MODEL set to: $argv[1]"
end

# Quick API key setup function
function cco-key
  if test (count $argv) -eq 0
    echo "Usage: cco-key <api-key>"
    echo "Sets CCO_API_KEY for session"
    return 1
  end
  set -gx CCO_API_KEY $argv[1]
  echo "✓ CCO_API_KEY set (hidden for security)"
end

# Show current CCO environment
function cco-env
  echo "CCO Environment:"
  echo "  CCO_HOME: $CCO_HOME"
  if set -q CCO_API_KEY
    echo "  CCO_API_KEY: (set)"
  else
    echo "  CCO_API_KEY: (not set)"
  end
  if set -q CCO_MODEL
    echo "  CCO_MODEL: $CCO_MODEL"
  else
    echo "  CCO_MODEL: (not set)"
  end
  echo "  CCO Binary: %s"
end

# Completion (if available)
if command -v %s &> /dev/null
  %s completion fish | source 2>/dev/null || true
end

echo "✓ CCO shell environment activated"
echo "  Run 'cco-env' to see environment variables"
echo "  Run 'cco-model' to set the active model"
`, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary, ccoBinary)
}
